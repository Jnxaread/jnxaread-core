<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jnxaread.dao.wrap.TopicMapperWrap">
  <resultMap extends="com.jnxaread.dao.TopicMapper.ResultMapWithBLOBs" id="ResultMapWithUsername" type="com.jnxaread.bean.wrap.TopicWrap">
    <result column="username" jdbcType="VARCHAR" property="username"></result>
    <result column="lastReply" jdbcType="VARCHAR" property="lastReply"></result>
    <result column="lastSubmit" jdbcType="TIMESTAMP" property="lastSubmit"></result>
  </resultMap>
  <select id="findListWithUsername" parameterType="java.lang.Integer" resultMap="ResultMapWithUsername">
    SELECT a.*,IFNULL(b.lastSubmit,a.createTime) lastSubmit,IFNULL(b.lastReply,a.username) lastReply FROM
    (SELECT topic.*,user.username FROM topic,user WHERE topic.restricted&lt;=#{level} AND topic.visible=1 AND topic.deleted=0 AND topic.userId=user.id
    <if test="userId!=0">
      AND topic.userId=#{userId}
    </if>
    ) a LEFT JOIN
    (SELECT lastSubmit,user.username lastReply,reply.topicId rti FROM
    (SELECT MAX(reply.createTime) lastSubmit FROM reply GROUP BY reply.topicId) ma,reply,user
    WHERE lastSubmit=reply.createTime AND reply.userId=user.id) b
    ON a.id=b.rti ORDER BY lastSubmit DESC limit #{startRow},#{pageSize}
  </select>
  <select id="findWithUsername" parameterType="java.lang.Integer" resultType="com.jnxaread.bean.wrap.TopicWrap">
    SELECT topic.id,topic.createTime,topic.label,topic.title,topic.content,topic.replyCount,topic.viewCount,user.username
    FROM topic,user WHERE topic.id=#{id} AND topic.visible=1 AND topic.deleted=0 AND topic.userId=user.id
  </select>
  <select id="selectByPrimaryKeyForUpdate" parameterType="java.lang.Integer" resultType="com.jnxaread.bean.Topic">
    select id,replyCount,locked,deleted from topic where id=#{id} for update
  </select>
  <update id="updateViewCountByPrimaryKey" parameterType="java.lang.Integer">
    update topic set viewCount=viewCount+1 where id=#{id}
  </update>
  <update id="updateReplyCountByPrimaryKey" parameterType="java.lang.Integer">
    update topic set replyCount=replyCount+1 where id=#{id}
  </update>
</mapper>
